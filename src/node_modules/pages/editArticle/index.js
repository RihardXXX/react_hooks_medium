import React, {useContext, useEffect, useState} from "react";
import { Redirect } from "react-router-dom";
import { CurrentUserContext } from 'context/currentUserContext';
import useFetch from 'hooks/useFetch';
import ArticleForm from 'components/ArticleForm';


const EditArticle = ({match}) => {

    const [currentUserState] = useContext(CurrentUserContext);
    const { slug } = match.params;
    const apiUrl = `/articles/${slug}`;
    const [{response:  responseArticle, errors}, doFetchArticle] = useFetch(apiUrl);
    const [{response: responseNewArticle,}, doUpdateArticle] = useFetch(apiUrl);
    const [initialValue, setInitialValue] = useState(null);

    // console.log(currentUserState.isLoggedIn);

    const handleSubmit = article => {
        doUpdateArticle({
            method: 'put',
            data: {
                article,
            }
        })
    };

    useEffect(() => {
        doFetchArticle();
    }, [doFetchArticle]);

    useEffect(() => {
        if (!responseArticle) {
            return;
        }
        const { title, description, body, tagList } = responseArticle.data.article
        setInitialValue({ title, description, body, tagList });
    }, [responseArticle]);

    // if (currentUserState.isLoggedIn === null) {
    //     return null
    // }
    //
    // if (currentUserState.isLoggedIn === false) {
    //     return <Redirect to="/" />
    // }

    if (responseNewArticle) {
        return <Redirect to={`/article/${responseNewArticle.data.article.slug}`} />;
    }

    return (
        <div>
            <ArticleForm
                onSubmit={handleSubmit}
                errors={(errors && errors.errors) || {}}
                initialValue={initialValue}
            />
        </div>
    )
}

export default EditArticle;
